<!DOCTYPE html>

<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Genshin Calculator</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        
        <link href="https://cdn.jsdelivr.net/npm/modern-normalize@v2.0.0/modern-normalize.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

        <script src="https://cdn.jsdelivr.net/npm/mathjs@13.0.3/lib/browser/math.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <script src="Wish_Calculator_JS.mjs" type="text/javascript"></script>
        <script src="https://parsleyjs.org/dist/parsley.js"></script>

        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"></script>
    </head>
    <body>
        <style>
            body, html {
                margin-bottom: 2.5%;
                margin-top: 2.5%;
            }

            body { 
                color: black;
                background-color: #137b85;
            }

            #LoadingSpinner {
                width: 50px;
                height: 50px;
                border: 3px solid rgba(255,255,255,.3);
                border-radius: 50%;
                border-top-color: #fff;
                animation: spin 1s ease-in-out infinite;
                -webkit-animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }
            @-webkit-keyframes spin {
                to { -webkit-transform: rotate(360deg); }
            }

            ul.parsley-errors-list {
                list-style-type: none;
                padding: 0;
                margin: 0;
                color: #800000;
            }

            a.help-tooltip  {
                height: 25px; 
                width: 25px;
                border-color: #0DCAF0;
            }

            i.tooltip-question-icon {
                color: #0DCAF0;
                font-size: 18px;
                margin-left: .75px;
                transform: translateY(-18%);
                align-items: center;
                flex-direction: column;
            }

            .TableInput {
                border-color: black;
            }

            .swal-button {
                background-color: #4962B3;
            }

            .swal-button:not([disabled]):hover {
                background-color: #5b71ba;
            }

            .btn-add {
                background: #52b4fa;
            }

            .btn-add:not([disabled]):hover {
                background: #90d5ff;
            }
        </style>

        <center><h1>Genshin Wish And Gacha Calculator</h1><center>
        <center><h2 style="color: #800000;">This site is still under construction. Certain features and functionality may not be fully implemented yet.</h2></center><br>
        <br>

        <form id="form" data-parsley-validate="true">
            <div class="container">
                <hr><center><h2>Calculator Settings</h2></center><br>
                
                <div class="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="ImportAccordion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ImportAccordionContent" aria-expanded="false" aria-controls="ImportAccordionContent">
                                <h4 class="d-block w-100 text-center">Import</h4>
                            </button>
                        </h2>
                        <div id="ImportAccordionContent" class="accordion-collapse collapse" aria-labelledby="ImportAccordion" data-bs-parent="#ImportAccordion">
                            <div class="accordion-body">
                                <label for="ImportState" class="form-label">[PLACE HOLDER DESCRIPTION]</label><br>
                                <textarea id="ImportState" class="form-control"></textarea><br>
                                <p id="InvalidImportMessage" style="color: red; display: none;">Invalid Import.</p>
                                <center>
                                    <a id="Import" class="btn btn-primary" style="border-color: black;" onclick="Import(Scroll=true)"> Import </a>
                                    <a class="btn btn-primary" style="border-color: black;" onclick="Import(Scroll=false); $('#Calculate').trigger('click');"> Import and Run </a>
                                </center>
                                <br>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="ExportAccordion">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ExportAccordionContent" aria-expanded="false" aria-controls="ExportAccordionContent">
                                <h4 class="d-block w-100 text-center">Export</h4>
                            </button>
                        </h2>
                        <div id="ExportAccordionContent" class="accordion-collapse collapse" aria-labelledby="ExportAccordion" data-bs-parent="#ExportAccordion">
                            <div class="accordion-body">
                                <label for="ExportState" class="form-label">[PLACE HOLDER DESCRIPTION]</label><br>
                                <textarea id="ExportState" class="form-control" disabled></textarea><br>
                                


                            </div>
                        </div>
                    </div>
                </div>
                <br>
                
                <center>
                    <input type="checkbox" id="SimpleMode" class="form-check-input">
                    <label for="SimpleMode" class="form-label">Simple Wishing Mode</label>
                    <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                        title="This mode will allow you to run the calculator with just the ammount of resources you have at the moment."
                    >
                        <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                    </a>
                </center>

                <center class="SimpleModeSkipGroup">
                    <input type="checkbox" id="EnableEventCalcs" class="form-check-input">
                    <label for="EnableEventCalcs" class="form-label">Factor in events (beta)</label>
                    <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                        title="If checked, then the calculator will assume that each patch there will be 1 flagship event, awarding <b>900 Primogems</b> and 3 secondary events, each awarding <b>420 Primogems</b>."
                    >
                        <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                    </a>
                </center>

                <a id="CalculatorHeaderAnchor"></a>

                <div class="WishSection">
                    <hr><center><h2>Currency</h2></center><br>

                    <div class="row">
                        <div class="col-sm">
                            <label for="Primos" class="form-label">Primogems</label><br>
                            <input type="number" id="Primos" class="form-control" data-parsley-trigger="change" data-parsley-required="true" Value="0"><br>
                        </div>
                    
                        <div class="col-sm">
                            <label for="IntertwinedFates" class="form-label">Intertwined Fates</label><br>
                            <input type="number" id="IntertwinedFates" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>

                        <div class="col-sm SimpleModeSkipGroup">
                            <label for="Stardust" class="form-label">Masterless Stardust</label>
                            <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                                title="This will be used to calculate how many of the available Intertwined Fates you can purchase from the Stardust Exchange between now and the <b>Wishing End Date</b>. If left empty then the calculator will assume all available Intertwined Fates can be purchased. It is assumed that this month's Intertwined Fates have already been purchased."
                            >
                                <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                            </a>
                            <br>
                            <input type="number" id="Stardust" class="form-control" data-parsley-trigger="change" data-parsley-min="0" min="0"><br>
                        </div>
                    </div>
                    <br>

                    <center>
                        <input type="checkbox" id="UsingStarglitter" class="form-check-input">
                        <label for="UsingStarglitter" class="form-label">Using Masterless Starglitter</label><br>
                    </center>

                    <div class="row" id="StarglitterSkipGroup" style="display: none;">
                        <div class="col-sm">
                            <label for="Starglitter" class="form-label">Masterless Starglitter</label><br>
                            <input type="number" id="Starglitter" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="0"><br>
                        </div>
                    
                        <div class="col-sm">
                            <label for="MissingFourStars" class="form-label">Missing 4&#9733; Characters</label>
                            <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                                title="If all 4&#9733; characters have been acquired then every 4&#9733; pulled should give at least 2 Masterless Starglitter. The calculator will assume that a 4&#9733; is given once every 10 wishes, and so if all 4&#9733;s are acquired before or during the wishing process then 2 additional Masterless Starglitter will be awarded per subsequent wish."
                            >
                                <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                            </a>
                            <br>
                            <input type="number" id="MissingFourStars" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="38"><br>
                        </div>

                        <div class="col-sm">
                            <label for="MissingFiveStars" class="form-label">Missing Standard Banner 5&#9733; Characters</label>
                            <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                                title="5&#9733; character constellations will award 10 Masterless Starglitter and so if all standard banner 5&#9733;s are acquired before or during the wishing process then 10 additional Masterless Starglitter will be awarded every following time you pull a standard banner 5&#9733;. Additional wishes gained from this won't be factored into the <b>Max Number of Wishes</b>."
                            >
                                <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                            </a>
                            <br>
                            <input type="number" id="MissingFiveStars" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="7"><br>
                        </div>
                    </div>
                </div>

                <div class="WishSection">
                    <hr><center><h2>Wishing Info</h2></center><br>

                    <center class="SimpleModeSkipGroup">
                        <input type="checkbox" id="AdvancedWishPlanning" class="form-check-input">
                        <label for="AdvancedWishPlanning" class="form-label">Advanced Wish Planning</label>
                        <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                            title="<b>Advanced wish planning</b> will allow you to specify which characters and weapons you want to wish for, the order you will be wishing for them in, and the end dates of each banner."
                        >
                            <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                        </a>
                    </center>

                    <div class="justify-content-md-center SimpleModeSkipGroup SimpleWishPlanningSkipGroup">
                        <center>
                            <div style="align-content: center;">
                                <label for="EndPatch" class="form-label">What banner will you have made all your wishes by?</label>
                                <select id="BannerEnd" class="form-select" style="max-width: 300px;">
                                    <!-- Filled in by GetBannerInfo. -->
                                </select>
                            </div>
                        </center>
                    </div>
                    <br>

                    <table class="table table-bordered" style="font-size: min(3vw, 16px); text-align: center; border: 1px; max-width: 100%;">
                        <thead>
                            <tr>
                                <td></td>
                                <td><b>Character Banner</b></td>
                                <td><b>Weapon Banner</b></td>
                                <td><b>Chronicled Wish</b></td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class='SimpleWishPlanningSkipGroup'>
                                <td style="vertical-align: middle;"><b>Number of 5&#9733;s Wishing For</b></td>
                                <td>
                                    <input type="number" id="CharacterGoal" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="WeaponGoal" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledGoal" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Pity</b></td>
                                <td>
                                    <input type="number" id="CharacterPity" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 89]" min="0" max="89" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="WeaponPity" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 79]" min="0" max="79" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledPity" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 89]" min="0" max="89" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Guarantee</b></td>
                                <td>
                                    <input type="checkbox" id="CharacterGuarantee" class="form-check-input TableInput">
                                </td>
                                <td>
                                    <input type="checkbox" id="WeaponGuarantee" class="form-check-input TableInput">
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;"><b>Fate Points</b></td>
                                <td></td>
                                <td>
                                    <input type="number" id="WeaponFatePoints" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 1]" min="0" max="1" Value="0">
                                </td>
                                <td>
                                    <input type="number" id="ChronicledFatePoints" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 1]" min="0" max="1" Value="0">
                                </td>
                            </tr>
                            <tr>
                                <td style="vertical-align: middle;">
                                    <b id="CapturingRadianceLabel">Capturing Radiance Pity</b>
                                    <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle" 
                                        title="
                                            When pulling on a character banner, if you obtain a 5&#9733; character and they are not the event character, you will gain one <b>Capturing Radiance Pity</b>. If you obtain the event character without the <b>Guarantee</b>, then your <b>Capturing Radiance Pity</b> will be reset to 0. Your <b>Capturing Radiance Pity</b> will alter your chances of obtaining the event character without the <b>Guarantee</b>, as follows:
                                            <br><br>
                                            <ul>
                                                <li> 0 Pity: 50% Chance   </li>
                                                <li> 1 Pity: 52.5% Chance </li>
                                                <li> 2 Pity: 75% Chance   </li>
                                                <li> 3 Pity: 100% Chance  </li>
                                            </ul>
                                            These numbers come from a speculative model, based on wish results following this mechanics addition to the game, and as such may not be entirely accurate.
                                        "
                                    >
                                        <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                                    </a>
                                    <br>

                                    <input type="checkbox" id="EnableCapturingRadiance" class="form-check-input TableInput">
                                    <label for="EnableCapturingRadiance" class="form-label">Enable</label>
                                </td>
                                <td>
                                    <div id="CapturingRadiancePitySkipGroup">
                                        <input type="number" id="CapturingRadiancePity" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 3]" min="0" max="3" Value="0">
                                    </div>
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <table id="WishPlanningTable" class="table table-bordered" style="font-size: min(3vw, 16px); text-align: center; border: 1px; max-width: 100%;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Banner Type</th>
                            <th>Wishing End Date</th>
                            <th>Number of Copies</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="WishPlanningTableBody">
                        <!--- Rows will be added by jquery. --->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5">
                                <button id="AddRowButton" type="button" style="width: 100%" class="btn btn-add">
                                    <b><i class="bi bi-plus-lg" style="font-size: 30px; font-weight: bold; color: white;"></i></b>
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <script>
                    $(function() {
                        let NewWishPlanRowID = 1;

                        $('#WishPlanningTableBody').sortable();

                        $("#AddRowButton").click(function() {
                            let newRow = $(
                                `<tr id="WishPlanRowID${NewWishPlanRowID}">`+
                                    `<td><input id="WishPlanItem${NewWishPlanRowID}" type="text" class="form-control TableInput"></td>`+
                                    `<td>`+
                                        `<select id="WishPlanType${NewWishPlanRowID}" class="form-select TableInput" style="max-width: 175px;">`+
                                            `<option value=1> Character </option>`+
                                            `<option value=2> Weapon </option>`+
                                            `<option value=3> Chronicled Wish </option>`+
                                        `</select>`+
                                    `</td>`+
                                    `<td id="WishPlanBannerEndCell${NewWishPlanRowID}"></td>`+
                                    `<td><input id="WishPlanGoal${NewWishPlanRowID}" type="number" class="form-control TableInput" data-parsley-trigger="change" data-parsley-required="true" data-parsley-min="0" min="0" Value="1"></td>`+
                                    `<td>`+
                                        `<button type="button" class="btn btn-danger" onclick="$('#WishPlanRowID${NewWishPlanRowID}').remove()">`+
                                            `<i class="bi bi-x-lg" style=" font-weight: bold;"></i>`+
                                        `</button>`+
                                    `</td>`+
                                `</tr>`
                            )

                            $('#WishPlanningTableBody').append(newRow);
                            $('#WishPlanningTableBody').sortable("refresh"); 
                            
                            let bannerEndDropdown = $(`<select id="WishPlanBannerEnd${NewWishPlanRowID}" class="form-select TableInput" style="max-width: 300px;"></select>`);

                            bannerEndDropdown.html($('#BannerEnd').html());

                            $(`#WishPlanBannerEndCell${NewWishPlanRowID}`).html(bannerEndDropdown)
                                                        
                            NewWishPlanRowID++;
                        });

                        // We will trigger 3 clicks so the table will by default start with 3 rows.
                        $("#AddRowButton").trigger('click');
                        $("#AddRowButton").trigger('click');
                        $("#AddRowButton").trigger('click');
                    });
                </script>

                <div class="WishSection SimpleModeSkipGroup">
                    <hr><center><h2>Spiral Abyss</h2></center><br>
                    <center><h3>Expected Stars:</h3></center>

                    <div class="row">
                        <div class="col-sm">
                            <label for="ExpectedStarsFloor9" class="form-label">Floor 9</label><br>
                            <input type="number" id="ExpectedStarsFloor9" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,9]" min="0" max="9" Value="0">
                        </div>
                    
                        <div class="col-sm">
                            <label for="ExpectedStarsFloor10" class="form-label">Floor 10</label><br>
                            <input type="number" id="ExpectedStarsFloor10" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,9]" min="0" max="9" Value="0">
                        </div>

                        <div class="col-sm">
                            <label for="ExpectedStarsFloor11" class="form-label">Floor 11</label><br>
                            <input type="number" id="ExpectedStarsFloor11" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,9]" min="0" max="9" Value="0">
                        </div>

                        <div class="col-sm">
                            <label for="ExpectedStarsFloor12" class="form-label">Floor 12</label><br>
                            <input type="number" id="ExpectedStarsFloor12" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,9]" min="0" max="9" Value="0">
                        </div>
                    </div>
                    <br>

                    <center>
                        <input type="checkbox" id="AbyssCurrentCycleCompleted" class="form-check-input">
                        <label for="AbyssCurrentCycleCompleted" class="form-label">Current cycle completed?</label><br>
                    </center>
                </div>


                <div class="WishSection SimpleModeSkipGroup">
                    <hr><center><h2>Imaginarium Theater</h2></center><br>

                    <div class="row">
                        <center>
                            <div class="col-sm-2">
                                <label for="ExpectedAct" class="form-label">Expected Act</label>
                                <input type="number" id="ExpectedAct" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,10]" min="0" max="10" Value="0"><br>
                            </div>
                            <div class="col-sm-3">
                                <input type="checkbox" id="ITCurrentCycleCompleted" class="form-check-input">
                                <label for="ITCurrentCycleCompleted" class="form-label">Current cycle completed</label><br>
                            </div>
                        </center>
                    </div>
                </div>

                <div class="WishSection SimpleModeSkipGroup">
                    <hr>
                    <center>
                        <h2>
                            Battle Pass & Welkin
                            <a type="button" data-toggle="tooltip" class="help-tooltip btn btn-dark rounded-circle"
                                title="This calculator will assume that the <b>Blessing of the Welkin Moon</b>/<b>Battle Pass</b> will either be purchased from now until the <b>Wishing End Date</b> or not at all."
                            >
                                <i class="d-flex bi bi-question-lg tooltip-question-icon"></i>
                            </a>
                        </h2>
                    </center>
                    <br>
                    <div class="row">
                        <center>
                            <div class="col-sm">
                                <input type="checkbox" id="HasWelkin" class="form-check-input">
                                <label for="HasWelkin" class="form-label">Purchasing Blessing of the Welking Moon</label>
                            </div>
                            <div class="col-sm-3">
                                <input type="checkbox" id="BPPurchased" class="form-check-input">
                                <label for="BPPurchased" class="form-label">Purchasing Battle Pass</label>
                            </div>
                        </center>
                    </div>

                    <div class="row">
                        <center>
                            <div class="col-sm-2" id="BPLevelSkipGroup" style="display: none;">
                                <label for="BPLevel" class="form-label">Battle Pass Level</label>
                                <input type="number" id="BPLevel" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0, 50]" min="0" max="50" Value="0">
                            </div>
                        </center>
                    </div>
                </div>


                <div id="EventCalcs" class="WishSection SimpleModeSkipGroup">
                    <hr><center><h2>Events (beta)</h2></center><br>

                    <center id="SecondaryEventsCompletableSkipGroup" style="max-width: 30%;">
                        <label for="SecondaryEventsCompletable" class="form-label">Final Patch's Secondary Events Completable by Wishing End Date</label>
                        <input type="number" id="SecondaryEventsCompletable" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,3]" min="0" max="3" Value="0"><br>
                    </center>

                    <center style="max-width: 30%;">
                        <label for="SecondaryEventsCompleted" class="form-label">Current Patch's Secondary Events Completed</label>
                        <input type="number" id="SecondaryEventsCompleted" class="form-control" data-parsley-trigger="change" data-parsley-required="true" data-parsley-range="[0,3]" min="0" max="3" Value="0"><br>
                    </center>

                    <center id="FlagshipEventCompletableSkipGroup">
                        <input type="checkbox" id="FlagshipEventCompletable" class="form-check-input">
                        <label for="FlagshipEventCompletable" class="form-label">Final Patch's Flagship Event Completable by Wishing End Date</label>
                    </center>

                    <center id="FlagshipEventCompletedSkipGroup">
                        <input type="checkbox" id="FlagshipEventCompleted" class="form-check-input">
                        <label for="FlagshipEventCompleted" class="form-label">Current Patch's Flagship Event Completed</label><br>
                    </center>
                </div>

                <hr>

                <center><a id="Calculate" class="btn btn-primary" style="border-width: 1px; border-color: black;"> Calculate </a></center><br>
            </div>
        </form>

        <div>
            <center>
                <div id="LoadingGroup" style="display: none;">
                    <div id="LoadingSpinner"></div>
                    <br>
                    <span id="LoadingText"></span>
                </div>

                <div id="Results" style="display: none;">
                    <div id="WishEndDate" style="display: none;"></div>

                    <div id="BannerEnded" style="display: none;"></div>

                    <div id="MaxWishes" style="display: none;"></div>

                    <div id="WishingGoals" style="display: none;"></div>

                    <div id="Chance" style="display: none;"></div>
                </div>
            </center>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            GetBannerInfo();

            let ResultsLoaded = false;

            function getInvalidFields() {
                let InvalidFields = [];
                
                $('input').each(function() {
                    if ( !$(this).parsley().isValid() && $(this).is(":visible") ) {
                        InvalidFields.push($(this).attr('id'));
                    }
                })

                return InvalidFields;
            }

            function UpdateCalculateButton() {
                let CalculateText = ResultsLoaded ? 'Recalculate' : 'Calculate'

                if ( $('#CharacterGoal').val() > 0 || $('#WeaponGoal').val() > 0 || $('#ChronicledGoal').val() > 0 ) {
                    $("#Calculate").html(CalculateText);
                    $("#Calculate").removeClass('disabled');
                }
                else {
                    $("#Calculate").html(CalculateText + "<br> <span style='font-size: small'>(Please select at least one character or weapon)</span>");
                    $("#Calculate").addClass('disabled');
                }
            }

            UpdateCalculateButton();
            $('#CharacterGoal, #WeaponGoal, #ChronicledGoal').on('change', UpdateCalculateButton)

            // TODO: Disable the button when clicked and reenable once its done processing.
            $("#Calculate").on('click', function() {
                $('#Results').hide();

                let InvalidFields = getInvalidFields();

                if (InvalidFields.length > 0) {
                    swal({
                        text: 'Please correct invalid data before running calculations.',
                        icon: 'error'
                    });

                    $('html, body').animate({
                        scrollTop: $(`#${InvalidFields[0]}`).offset().top-100,
                        easing: 'linear'
                    }, 250)
                }
                else {
                    if (ResultsLoaded) {
                        $('#LoadingText').html('Recalculating...');
                    }
                    else{
                        $('#LoadingText').html('Loading...');
                    }

                    $('#LoadingGroup').show();

                    $('html, body').animate({
                        scrollTop: $("#LoadingGroup").offset().top,
                        easing: 'linear'
                    }, 250)

                    setTimeout(function () {
                        WishCalcs(CompileForm());

                        ResultsLoaded = true

                        $('#LoadingGroup').hide();

                        $('#Results').show();

                        UpdateCalculateButton();
                    }, 500);
                }
            })

            $('#BannerEnd, #SecondaryEventsCompletable').on('change', function() {
                if ( ($('#BannerEnd').val() == $('#BannerEnd')[0].options[0].value) && (BannerInfo[$('#BannerEnd').val()].Phase == 1) ) {
                    $('#SecondaryEventsCompleted').attr('max', $('#SecondaryEventsCompletable').val());
                    
                    $('#SecondaryEventsCompleted').parsley({range: `[0, ${$('#SecondaryEventsCompletable').val()}]`});

                    $('#SecondaryEventsCompleted').trigger('input');
                }
                else {
                    $('#SecondaryEventsCompleted').attr('max', 3);

                    $('#SecondaryEventsCompleted').parsley({range: '[0, 3]'});

                    $('#SecondaryEventsCompleted').trigger('input');
                }
            })

            // Skip Logic
            $('#SimpleMode').on('change', function () {
                if ($('#SimpleMode').is(':checked')) {
                    $('.SimpleModeSkipGroup').hide();
                    $('#AdvancedWishPlanning').prop('checked', false).change();
                }
                else {
                    $('.SimpleModeSkipGroup').show();
                }
            })

            $('#AdvancedWishPlanning').on('change', function () {
                if ($('#AdvancedWishPlanning').is(':checked')) {
                    $('.SimpleWishPlanningSkipGroup').hide();
                    $('#WishPlanningTable').show();
                }
                else {
                    $('.SimpleWishPlanningSkipGroup').show();
                    $('#WishPlanningTable').hide();
                }
            })

            $('#EnableEventCalcs').on('change', function () {
                if ( $('#EnableEventCalcs').is(':checked') && !$('#SimpleMode').is(':checked')) {
                    $('#EventCalcs').show();
                }
                else {
                    $('#EventCalcs').hide();
                }
            })

            $('#BannerEnd').on('change', function () {
                if (BannerInfo[$('#BannerEnd').val()].Phase == 1) {
                    $('#FlagshipEventCompletableSkipGroup').show().trigger('input');
                    $('#SecondaryEventsCompletableSkipGroup').show().trigger('input');
                }
                else {
                    $('#FlagshipEventCompletableSkipGroup').hide();
                    $('#SecondaryEventsCompletableSkipGroup').hide();

                    $('#FlagshipEventCompletedSkipGroup').show();

                    $('#SecondaryEventsCompleted').attr('max', 3);

                    $('#SecondaryEventsCompleted').parsley({range: '[0, 3]'});

                    $('#SecondaryEventsCompleted').trigger('input');
                }
            })

            $('#EnableCapturingRadiance').on('change', function () {
                if ($('#EnableCapturingRadiance').is(':checked')) {
                    $('#CapturingRadianceLabel').css('color', 'black');
                    $('#CapturingRadiancePitySkipGroup').show();
                }
                else {
                    $('#CapturingRadianceLabel').css('color', 'gray');
                    $('#CapturingRadiancePitySkipGroup').hide();
                };
            });

            $('#BannerEnd, #FlagshipEventCompletable').on('change', function () {
                if ( 
                    $('#BannerEnd').val() != $('#BannerEnd')[0].options[0].value
                    || BannerInfo[$('#BannerEnd').val()].Phase == 2
                    || $('#FlagshipEventCompletable').is(':checked')
                ) {
                    $('#FlagshipEventCompletedSkipGroup').show();
                }
                else {
                    $('#FlagshipEventCompletedSkipGroup').hide();
                }
            })

            $('#UsingStarglitter').on('change', function(){
                if ($('#UsingStarglitter').is(':checked')) {
                    $('#StarglitterSkipGroup').show();
                }
                else {
                    $('#StarglitterSkipGroup').hide();
                }
            });

            $('#BPPurchased').on('change', function(){
                if ($('#BPPurchased').is(':checked')) {
                    $('#BPLevelSkipGroup').show();
                }
                else {
                    $('#BPLevelSkipGroup').hide();
                }
            });

            function UpdateExportState(){
                if (getInvalidFields().length == 0) {
                    $('#ExportState').val(JSON.stringify(CompileForm()))
                }
                else {
                    $('#ExportState').val('Invalid information detected. Cannot generate export.')
                }
            };

            function CompileForm(){
                let FormValues = {};
                
                $('#form input, #form select').each(function() {
                    if ($(this).is(':checkbox')) {
                        FormValues[this.id] = $(this).is(':checked')
                    }
                    else {
                        FormValues[this.id] = this.value == '' ? '' : Number(this.value);
                    }
                });

                return FormValues
            };

            $('#form').on('input', UpdateExportState);

            function Import(Scroll) {
                let isValidJSON = true;
                let JSONImport;

                try {
                    JSONImport = JSON.parse($('#ImportState').val());
                } catch (error) {
                    isValidJSON = false;
                }

                if (isValidJSON) {
                    $('#InvalidImportMessage').hide();

                    if (JSONImport['BannerEnd'] < $('#BannerEnd')[0].options[0].value) {
                        swal({
                            text: 'Banner end date was not imported as it has already passed. All other fields have been successfully imported.',
                            icon: 'info'
                        });

                        JSONImport['BannerEnd'] = $('#BannerEnd')[0].options[0].value;
                    }
                    else if (JSONImport['BannerEnd'] >= BannerInfo.length) {
                        swal({
                            text: 'Banner end date was not imported as it is too far in the future. All other fields have been successfully imported.',
                            icon: 'info'
                        });

                        JSONImport['BannerEnd'] = $('#BannerEnd')[0].options[0].value;
                    }

                    $('#form input, #form select').each(function() {
                        if ($(this).is(':checkbox')) {
                            $(this).prop('checked', JSONImport[this.id]);
                        }
                        else {
                            $(this).val(JSONImport[this.id]);
                        }
                    })

                    $('input').change().trigger('input');

                    if (Scroll == true) {
                        $('html, body').animate({
                            scrollTop: $("#CalculatorHeaderAnchor").offset().top,
                            easing: 'linear'
                        }, 500);
                    };
                }
                else {
                    $('#InvalidImportMessage').show();
                }
            };

            $(function () {
                $('a[data-toggle="tooltip"]').each(function() {
                    $(this).tooltip({
                        html: true
                    });
                });
            });

            $('input:not([type="checkbox"])').on('input', function(){
                if (!$(this).parsley().isValid()) {
                    $(this).css('background-color', '#E55451');
                }
                else{
                    $(this).css('background-color', 'white');
                }
            });

            $('input').change().trigger('input');

            $(document).ready(function(){
                $('input').each(function() {
                    $(this).parsley().validate();
                })
            });
        </script>
    </body>
</html>